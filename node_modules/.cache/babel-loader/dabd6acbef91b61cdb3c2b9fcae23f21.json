{"ast":null,"code":"import _objectSpread from \"/Users/jenniferhe/Documents/GitHub/2022-Chia1/webapp/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _asyncToGenerator from \"/Users/jenniferhe/Documents/GitHub/2022-Chia1/webapp/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _asyncIterator from \"/Users/jenniferhe/Documents/GitHub/2022-Chia1/webapp/node_modules/@babel/runtime/helpers/esm/asyncIterator.js\";\nimport _regeneratorRuntime from \"/Users/jenniferhe/Documents/GitHub/2022-Chia1/webapp/node_modules/@babel/runtime/regenerator/index.js\";\nimport debug from 'debug';\nimport { configure } from '../lib/configure.js';\nimport { toUrlSearchParams } from '../lib/to-url-search-params.js';\nimport { textToUrlSafeRpc, rpcArrayToTextArray, rpcToBytes } from '../lib/http-rpc-wire-format.js';\nvar log = debug('ipfs-http-client:pubsub:subscribe');\nexport var createSubscribe = function createSubscribe(options, subsTracker) {\n  return configure(function (api) {\n    function subscribe(_x, _x2) {\n      return _subscribe.apply(this, arguments);\n    }\n\n    function _subscribe() {\n      _subscribe = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(topic, handler) {\n        var options,\n            done,\n            fail,\n            result,\n            ffWorkaround,\n            _args = arguments;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                options = _args.length > 2 && _args[2] !== undefined ? _args[2] : {};\n                options.signal = subsTracker.subscribe(topic, handler, options.signal);\n                result = new Promise(function (resolve, reject) {\n                  done = resolve;\n                  fail = reject;\n                });\n                ffWorkaround = setTimeout(function () {\n                  return done();\n                }, 1000);\n                api.post('pubsub/sub', {\n                  signal: options.signal,\n                  searchParams: toUrlSearchParams(_objectSpread({\n                    arg: textToUrlSafeRpc(topic)\n                  }, options)),\n                  headers: options.headers\n                }).catch(function (err) {\n                  subsTracker.unsubscribe(topic, handler);\n                  fail(err);\n                }).then(function (response) {\n                  clearTimeout(ffWorkaround);\n\n                  if (!response) {\n                    return;\n                  }\n\n                  readMessages(response, {\n                    onMessage: handler,\n                    onEnd: function onEnd() {\n                      return subsTracker.unsubscribe(topic, handler);\n                    },\n                    onError: options.onError\n                  });\n                  done();\n                });\n                return _context.abrupt(\"return\", result);\n\n              case 6:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n      return _subscribe.apply(this, arguments);\n    }\n\n    return subscribe;\n  })(options);\n};\n\nfunction readMessages(_x3, _x4) {\n  return _readMessages.apply(this, arguments);\n}\n\nfunction _readMessages() {\n  _readMessages = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(response, _ref) {\n    var onMessage, onEnd, onError, _iteratorAbruptCompletion, _didIteratorError, _iteratorError, _iterator, _step, msg;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            onMessage = _ref.onMessage, onEnd = _ref.onEnd, onError = _ref.onError;\n            onError = onError || log;\n            _context2.prev = 2;\n            _iteratorAbruptCompletion = false;\n            _didIteratorError = false;\n            _context2.prev = 5;\n            _iterator = _asyncIterator(response.ndjson());\n\n          case 7:\n            _context2.next = 9;\n            return _iterator.next();\n\n          case 9:\n            if (!(_iteratorAbruptCompletion = !(_step = _context2.sent).done)) {\n              _context2.next = 24;\n              break;\n            }\n\n            msg = _step.value;\n            _context2.prev = 11;\n\n            if (msg.from) {\n              _context2.next = 14;\n              break;\n            }\n\n            return _context2.abrupt(\"continue\", 21);\n\n          case 14:\n            onMessage({\n              from: msg.from,\n              data: rpcToBytes(msg.data),\n              seqno: rpcToBytes(msg.seqno),\n              topicIDs: rpcArrayToTextArray(msg.topicIDs)\n            });\n            _context2.next = 21;\n            break;\n\n          case 17:\n            _context2.prev = 17;\n            _context2.t0 = _context2[\"catch\"](11);\n            _context2.t0.message = \"Failed to parse pubsub message: \".concat(_context2.t0.message);\n            onError(_context2.t0, false, msg);\n\n          case 21:\n            _iteratorAbruptCompletion = false;\n            _context2.next = 7;\n            break;\n\n          case 24:\n            _context2.next = 30;\n            break;\n\n          case 26:\n            _context2.prev = 26;\n            _context2.t1 = _context2[\"catch\"](5);\n            _didIteratorError = true;\n            _iteratorError = _context2.t1;\n\n          case 30:\n            _context2.prev = 30;\n            _context2.prev = 31;\n\n            if (!(_iteratorAbruptCompletion && _iterator.return != null)) {\n              _context2.next = 35;\n              break;\n            }\n\n            _context2.next = 35;\n            return _iterator.return();\n\n          case 35:\n            _context2.prev = 35;\n\n            if (!_didIteratorError) {\n              _context2.next = 38;\n              break;\n            }\n\n            throw _iteratorError;\n\n          case 38:\n            return _context2.finish(35);\n\n          case 39:\n            return _context2.finish(30);\n\n          case 40:\n            _context2.next = 45;\n            break;\n\n          case 42:\n            _context2.prev = 42;\n            _context2.t2 = _context2[\"catch\"](2);\n\n            if (!isAbortError(_context2.t2)) {\n              onError(_context2.t2, true);\n            }\n\n          case 45:\n            _context2.prev = 45;\n            onEnd();\n            return _context2.finish(45);\n\n          case 48:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[2, 42, 45, 48], [5, 26, 30, 40], [11, 17], [31,, 35, 39]]);\n  }));\n  return _readMessages.apply(this, arguments);\n}\n\nvar isAbortError = function isAbortError(error) {\n  switch (error.type) {\n    case 'aborted':\n      return true;\n\n    case 'abort':\n      return true;\n\n    default:\n      return error.name === 'AbortError';\n  }\n};","map":{"version":3,"sources":["/Users/jenniferhe/Documents/GitHub/2022-Chia1/webapp/node_modules/ipfs-http-client/esm/src/pubsub/subscribe.js"],"names":["debug","configure","toUrlSearchParams","textToUrlSafeRpc","rpcArrayToTextArray","rpcToBytes","log","createSubscribe","options","subsTracker","api","subscribe","topic","handler","signal","result","Promise","resolve","reject","done","fail","ffWorkaround","setTimeout","post","searchParams","arg","headers","catch","err","unsubscribe","then","response","clearTimeout","readMessages","onMessage","onEnd","onError","ndjson","msg","from","data","seqno","topicIDs","message","isAbortError","error","type","name"],"mappings":"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","sourcesContent":["import debug from 'debug';\nimport { configure } from '../lib/configure.js';\nimport { toUrlSearchParams } from '../lib/to-url-search-params.js';\nimport {\n  textToUrlSafeRpc,\n  rpcArrayToTextArray,\n  rpcToBytes\n} from '../lib/http-rpc-wire-format.js';\nconst log = debug('ipfs-http-client:pubsub:subscribe');\nexport const createSubscribe = (options, subsTracker) => {\n  return configure(api => {\n    async function subscribe(topic, handler, options = {}) {\n      options.signal = subsTracker.subscribe(topic, handler, options.signal);\n      let done;\n      let fail;\n      const result = new Promise((resolve, reject) => {\n        done = resolve;\n        fail = reject;\n      });\n      const ffWorkaround = setTimeout(() => done(), 1000);\n      api.post('pubsub/sub', {\n        signal: options.signal,\n        searchParams: toUrlSearchParams({\n          arg: textToUrlSafeRpc(topic),\n          ...options\n        }),\n        headers: options.headers\n      }).catch(err => {\n        subsTracker.unsubscribe(topic, handler);\n        fail(err);\n      }).then(response => {\n        clearTimeout(ffWorkaround);\n        if (!response) {\n          return;\n        }\n        readMessages(response, {\n          onMessage: handler,\n          onEnd: () => subsTracker.unsubscribe(topic, handler),\n          onError: options.onError\n        });\n        done();\n      });\n      return result;\n    }\n    return subscribe;\n  })(options);\n};\nasync function readMessages(response, {onMessage, onEnd, onError}) {\n  onError = onError || log;\n  try {\n    for await (const msg of response.ndjson()) {\n      try {\n        if (!msg.from) {\n          continue;\n        }\n        onMessage({\n          from: msg.from,\n          data: rpcToBytes(msg.data),\n          seqno: rpcToBytes(msg.seqno),\n          topicIDs: rpcArrayToTextArray(msg.topicIDs)\n        });\n      } catch (err) {\n        err.message = `Failed to parse pubsub message: ${ err.message }`;\n        onError(err, false, msg);\n      }\n    }\n  } catch (err) {\n    if (!isAbortError(err)) {\n      onError(err, true);\n    }\n  } finally {\n    onEnd();\n  }\n}\nconst isAbortError = error => {\n  switch (error.type) {\n  case 'aborted':\n    return true;\n  case 'abort':\n    return true;\n  default:\n    return error.name === 'AbortError';\n  }\n};"]},"metadata":{},"sourceType":"module"}